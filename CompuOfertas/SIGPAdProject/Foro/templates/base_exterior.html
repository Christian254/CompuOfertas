{% load staticfiles %}
<!DOCTYPE html>
<html lang="es">

  <head>

    <!--META-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>
        {% block Titulo %} SIGPAd {% endblock Titulo %}
    </title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'interior/css/admin.css'%}">
    <link href="{% static 'exterior/vendor/bootstrap/css/bootstrap.min.css'%}" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Custom fonts for this template -->
    <link href="{% static 'exterior/vendor/fontawesome-free/css/all.min.css'%}" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- Plugin CSS -->
    <link href="{% static 'exterior/vendor/magnific-popup/magnific-popup.css'%}" rel="stylesheet" type="text/css">

    <!-- Custom styles for this template -->
    <link href="{% static 'exterior/css/freelancer.css'%}" rel="stylesheet">

    <!-- Mini Chat -->
    <link href="{% static 'css/mini_chat.css'%}" rel="stylesheet" type="text/css">

    <!-- Para Footer y Mini Chat-->
    <style>
        .abajo {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            color: white;
        }
    </style>
    {% block CSS %} {% endblock CSS %}

    {% block cssMensaje %}{% endblock %}

  </head>

  <body id="page-top">
        
    {% block Navegacion %}
    {% endblock Navegacion %}

    {% block Body %} 
    {% endblock Body %}    

    {% block Footer %}
    {% endblock Footer %}

    {% if user.is_authenticated %}
    <div id="prueba_2"></div>
  {% endif %}
    <!-- Bootstrap core JavaScript -->
    <script src="{% static 'exterior/vendor/jquery/jquery.min.js'%}"></script>
    <script src="{% static 'exterior/vendor/bootstrap/js/bootstrap.bundle.min.js'%}"></script>

    <!-- Plugin JavaScript -->
    <script src="{% static 'exterior/vendor/jquery-easing/jquery.easing.min.js'%}"></script>
    <script src="{% static 'exterior/vendor/magnific-popup/jquery.magnific-popup.min.js'%}"></script>

    <!-- Contact Form JavaScript -->
    <script src="{% static 'exterior/js/jqBootstrapValidation.js'%}"></script>
    <script src="{% static 'exterior/js/contact_me.js'%}"></script>

    <!-- Custom scripts for this template -->
    <script src="{% static 'exterior/js/freelancer.min.js'%}"></script>
    {% block Script %} {% endblock Script %}

  </body>

  {% if user.is_authenticated %}

    
  <script type="text/javascript">

    var nombre;
    $(document).ready(function() {
        var refreshId = setInterval(peticionChat, 3000);
        $.ajaxSetup({
            cache: false
        });
    });

    //Para el footer de botones.
    function peticionChat() {
        $.get("/servicio_chat/", function(data, status) {
            var cant = data.length;
            $('#footer_botones').empty();
            $('#msjUser').empty();
            
            var v = `
                <li><a class="py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="/mensajes/0"><font size="1">ver todos</font></a></li>
                <li>
                <p class="number" style="color:black;"><font size="1">tienes <span id="tienes">0</span> mensajes</font></p>
                </li>
                `
            $(v).appendTo($('#msjUser'));
            $("#cant").text(cant);
            $("#tienes").text(cant);
        for(let i=0;i<=data.length;i++){
          var valor = data[i].fields;
          nombre = valor.username;
          var lista=`<p><li>
                    <a href="/mensajes/${valor.enviado}">
                    <span class="photo">
                      <img src="{% static "images/user.png" %}" height="40" width="40" style="margin-left:0px;" />
                    </span> 
                    <span class="subject"> 
                      <span class="from">
                        ${valor.username}
                      </span> 
                      <span class="time"><font size="0.4">
                        ${valor.fecha} </font>
                      </span>  
                    </span> 
                    <span class="message"><font size="1">
                       ${valor.msj}</font>
                    </span>
                  </a><br><br><br>
                </li>
                </p>`;
            
            $(lista).appendTo($('#msjUser'));
            var lista_2 = `<div class="btn-group"><div class="dropup">
              <button id="boton${i}" type="button" class="btn btn-secondary" data-toggle="dropdown" onclick="abrir_mini_chat(nombre, ${i},${valor.enviado})" style="margin-right: 7px"> ${valor.username} </button>
              <ul id="drop${i}" class="dropdown-menu" role="menu">
                <li id="lidrop${i}">
                  <div id="chat${i}" class="chat">
                    <header>
                          <h2 id="nombre_mini${i}" class='title'>
                           <!--Nombre-->
                           ${valor.username}
                          </h2>
                          <ul class='tools'>
                            <li>
                              <a class='fa fa-gear' href='#'></a>
                            </li>
                            <li>
                              <a class='fa fa-times' href='#'></a>  
                            </li>
                          </ul>
                    </header>
                    <div class="body">
                    <p>Hola</p>
                    </div>
                    <footer>
                        <a href='#'>Introduce un mensaje</a>
                    </footer>
                  </div>
                </li>
              </ul>
            </div></div>`;
            $(lista_2).appendTo($('#footer_botones'));


            
            }
        });
    }

    //Adentro.
    function abrir_mini_chat(name,correlativo,id_chat){        
        $.get("/mini_chat/"+id_chat, function(data,status){

            var id_user = {{user.id}};
            var cant = data.length;

            $("#prueba_2").empty();
            $("#prueba").empty();
            /*$("#chat"+correlativo).empty();
            var botdr = ``;
            $(botdr).appendTo($("#chat"+correlativo));*/
            
            for (let i = 0; i <= data.length; i++) {
                var valor = data[i].fields;
                var d = document.getElementsByClassName('prueba');


                  /*  var lista = `<li id="lista"> 
                  <a href="/mensajes/${valor.msj}" class="mail"> 
                    <span class="photo">
                      <img id="profile-img" src="{% static "images/user.png" %}"  class="online"  height="40" width="40" />
                    </span> 
                    <span class="subject"> 
                      <span class="from">
                        ${id_user}
                      </span> 
                      <span class="time">
                        justo ahora 
                      </span>  
                    </span> 
                    <span class="message">
                        ${valor.msj}
                    </span> 
                  </a>
                </li> <br> `;
                $(lista).appendTo($('#prueba'));*/
                var lista = [];
                if(id_user == valor.enviado){
                  lista = `<p>chat:${correlativo}</p>
                  <p><b>Emisor:</b>${id_user} ${valor.msj}</p>`;
                }else{
                  lista = `<p><b>Receptor:</b>${valor.enviado} ${valor.msj}</p>`;
                }

                var body = ``;
                
                $(lista).appendTo($('#prueba_2'));
                $(lista).appendTo($('#prueba'));
                $(body).appendTo($("#chat"+correlativo));



            }

        });
    }

</script>
  {% endif %}

</html>

